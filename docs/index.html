
<!doctype html>
<html lang="en" class="h-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Platform for minting NFT's using the OpenNFT contract">
    <meta name="author" content="Dalton Cole">
    <meta name="generator" content="Hugo 0.84.0">
    <title>OpenNFT - A DigOpp Experiment</title>
    <!-- Bootstrap core CSS -->
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <!-- Favicons -->
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>

    <meta name="theme-color" content="#7952b3">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }
    </style>

    <!-- Custom styles for this template -->
    <link href="cover.css" rel="stylesheet">
  </head>
  <body class="d-flex h-100 text-center text-white bg-dark">
    
    <div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
      <header class="mb-auto">
        <div>
          <h3 class="float-md-start mb-0">OpenNFT</h3>
          <nav class="nav nav-masthead justify-content-center float-md-end">
            <a class="nav-link" target="_blank" href="https://etherscan.io/address/0x4a4f4a202c840f7247cfcb429e1b41a5509176d8">Contract</a>
            <a class="nav-link" href="faq.html">FAQ</a>
            <p class="nav-link"><span class="showAccount"></span></p>
          </nav>
        </div>
      </header>

      <main class="px-3">
        <h1>Mint an NFT</h1>
        <p class="lead">To mint an NFT using our OpenNFT smart contract, just connect to metamask, upload an image, give it a name and description, and then click mint!</p>
        <p class="lead">
          <button id="connectMetamask" style="display: none;" class="btn btn-lg btn-secondary fw-bold border-white bg-white enableEthereumButton">Connect to Metamask</button>
          <form id="form">
            <input name="name" type="text" placeholder="Name" />
            <input name="description" type="textArea" placeholder="Description"/>
            <input name="file" type="file" />
            <a href="#" class="btn btn-lg btn-secondary fw-bold border-white bg-white formSubmit">Pin to IPFS</a>
            <p id="status"></p>
          </form>
        </p>
      </main>

      <footer class="mt-auto text-white-50">
        <p><a href="https://github.com/DigOppGroup/OpenNFT" class="text-white" target="_blank">Github</a> | <a href="https://digopp.group" class="text-white" target="_blank">Digital Opportunities Group</a> | <a href="https://twitter.com/0xjellyBeard" class="text-white" target="_blank">@0xjellyBeard</a>.</p>
        <p>Cover template for <a href="https://twitter.com/0xjellyBeard" class="text-white" target="_blank">Bootstrap</a>, by <a href="https://twitter.com/mdo" class="text-white" target="_blank">@mdo</a>.</p>
      </footer>
    </div>
  </body>
  <script>
    const ethereumButton = document.querySelector('.enableEthereumButton');
    const showAccount = document.querySelector('.showAccount');
    const formSubmit = document.querySelector('.formSubmit');
    const ipfsForm = document.querySelector("form");
    const networkId = ""
    var cid = ""

    const pinServiceURL = "https://66yog7g1k5.execute-api.us-east-1.amazonaws.com/"
    const addressMap = {
      "1": {
        networkName: "Mainnet",
        contractAddress: "0x4A4f4A202C840f7247CfCb429e1B41A5509176D8"}
        ,
      "3": {
        networkName: "Ropsten",
        contractAddress: "0x766eeb009d8f97acd285026d039783b985feac8e"}
    }

    const MinterABI = [
      {
        "inputs": [
          { "internalType": "address", "name": "recipient", "type": "address" },
          { "internalType": "string", "name": "tokenURI", "type": "string" }
        ],
        "name": "mintNFT",
        "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ]

    ethereumButton.addEventListener('click', () => {
      getAccount();
    });

    formSubmit.addEventListener('click', () => {
      submitForm();
    });

    async function loadWeb3() {
      if (typeof window.ethereum !== 'undefined') {
        console.log('MetaMask is installed!');
          window.web3 = new Web3(window.ethereum);
          window.ethereum.enable();
          ethereumButton.style.display = 'inline';
      } else {
        alert("Please use MetaMask.")
      }
    }

    async function load() {
      await loadWeb3();
      window.contract = await loadContract();
      networkId = await web3.eth.net.getId().to_string();
      console.log(networkId)
      updateStatus(`Connected to ${addressMap[networkId]["networkName"]}`);
    }

    function updateStatus(status) {
      const statusEl = document.getElementById('status');
      statusEl.innerHTML = status;
      console.log(status);
    }

    async function loadContract() {
      return await new window.web3.eth.Contract(MinterABI, addressMap[networkId]["contractAddress"]);
    }

    async function getAccount() {
      const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
      const account = accounts[0];
      showAccount.innerHTML = account.substring(0, 7) + "...";
      displayForm()
    }

    function displayForm() {
      ethereumButton.style.display = 'none';
      ipfsForm.style.display = 'block';
    }

    function submitForm() {
      const request = new XMLHttpRequest();
      request.onreadystatechange = function() {
        if (request.readyState == XMLHttpRequest.DONE) {
          responseJson = JSON.parse(request.responseText)
          cid = responseJson.IpfsHash
          showPreview()
        }
      }
      request.open("POST", pinServiceURL);
      request.send(new FormData(ipfsForm));
    }

    function showPreview() {
      ipfsForm.style.display = 'none';
      const metaDataURL = `https://gateway.pinata.cloud/ipfs/${cid}`
      fetch(metaDataURL).then(res => {return res.json()}).then(data=> {console.log(data)})
    }

    async function mintNFT() {
      const account = await getCurrentAccount();
      const metaURI = `ipfs://${cid}`
      const mint = await window.contract.methods.mintNFT(account, metaURI).send({ from: account });
      updateStatus('Updated.');
    }

    load()

  </script>
</html>
